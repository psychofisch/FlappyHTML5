<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">
        <script src="jquery-3.2.1.min.js"></script>
        <style type="text/css">
            body {
              margin:0; padding: 0; border:0; background: black;
                overflow: hidden;
            }

            div {
              position: absolute; margin: 0; padding: 0; border: 0;
                outline:0; color:white;
            }

            .sprite{
              background-image:url(sheet.png);
            }

            #viewport {
              width: 100%; height: 100%; overflow: hidden;
              top: 0px; left: 0px; margin: 0;
              background-color: #70C5CF;
              z-index: 0;
            }

            #bird {
              width: 34px;
              height: 24px;
              background-position: -312px -230px;
              z-index: 3;
              animation: cycle_sprites 300ms steps(1) infinite/*,
                          move_bird 5s linear infinite*/;
            }

            #start {
              background-position: -318px -382px;
              width: 80px;
              height: 28px;
              z-index: 3;
            }

            .city {
              background-position: -0px -410px;
              width: 276px;
              height: 200px;
            }

            #getready {
              background-position: -118px -310px;
              width: 288px;
              height: 38px;
            }

            .floor {
              background-position: -276px 0;
              width: 224px;
              height: 112px;
              z-index: 2;
            }

            .pipeN {
              /*251, 0, 26, 200*/
              background-position: -502px 0;
              width: 52px;
              height: 400px;
            }

            .pipeS {
              /*277, 0, 26, 200*/
              background-position: -554px 0;
              width: 52px;
              height: 400px;
            }

            .numberS {
              /* 0, 177, 6,  7 */
              background-position: 0 -354px;
              width: 12px;
              height: 14px;
            }

            .numberB {
              /* 0, 177, 6,  7 */
              background-position: 0 -376px;
              width: 14px;
              height: 20px;
            }

            .hidden {
              display: none;
            }

            #scorefield {
              margin-top: 10%;
              margin-left: 50%;
              transform: scale(2);
              /*text-align: center;*/
            }

            @keyframes cycle_sprites {
                0% { background-position: -312px -230px; }
                33.33% { background-position: -312px -256px;}
                66.66% { background-position: -312px -282px;}
            }

            @keyframes move_bird {
                from { left: 0px}
                to { left: 500px}
            }
        </style>
    </head>
    <body>
      <script type="text/javascript">
        //classes
        function Vec2()
        {
          this.x = 0;
          this.y = 0;
        }

        function Bird()
        {
          this.velocity = new Vec2();
          this.position = new Vec2();
          this.dom = undefined;
        }

        function Resize()
        {
          viewportSize.x = $("#viewport").width();
          viewportSize.y = $("#viewport").height();
          startBtn.css({"top": viewportSize.y * 0.5 - 40, "left": viewportSize.x * 0.5 - 14});

          bird.position.x = viewportSize.x * 0.3;
          bird.dom.css("left", bird.position.x);
          bird.position.y = viewportSize.y * 0.5;
          bird.dom.css("top", bird.position.y);

          console.log("resize!");
        }

        function createPipe(id, slot)
        {
          if(slot < 1)
            slot = 1;
          else if(slot > 3)
            slot = 3;
          console.log("pipe '" + id + "' created");
          viewport.append("<div class='hidden' id='"+id+"'><div class='sprite pipeN' id='"+id+"N'></div><div class='sprite pipeS' id='"+id+"S'></div></div>");
          var pipe = $("#"+id);
          var pipeN = $("#"+id+"N");
          var pipeS = $("#"+id+"S");
          var gap = 0.15;
          var usable = floor.deadzone;
          var positionY = (usable/4)*slot;
          pipeN.css("top", positionY+(usable*gap));
          pipeS.css("top", -pipeS.height()+positionY-(usable*gap));
          pipe.css("left", viewport.width());
          pipe.removeClass("hidden");
          return pipe;
        }

        function togglePause()
        {
          gamePause = !gamePause;

          if(gamePause){
            startBtn.show();
          } else {
              startBtn.hide();
          }
        }

        //some init stuff
        var bird = new Bird(),
            gamePause = true,
            viewportSize = new Vec2(),
            viewport,
            floor,
            floors,
            city,
            cities,
            startBtn,
            gameLoopInterval = undefined,
            startFrame = undefined,
            lastFrame = 0,
            deltaTime,
            distance = 0,
            numberProto,
            scorefield,
            pipes = [];

        //handler
        $(document).ready(function() {
          init();
        });

        $(window).resize(Resize);

        function init(){
          viewport = $("#viewport");
          viewport.html(
          "<div class='sprite' id='start'></div>"
          +"<div class='' id='scorefield'></div>"
          +"<div class='sprite' id='bird'></div>"
          +"<div id='city0' class='sprite city'></div>"
          +"<div id='floor0' class='sprite floor'></div>"
          +"<div id='numberProto' class='sprite numberS hidden'></div>"
          );

          //floors
          //viewport.append("<div id='floor0' class='sprite floor'></div>");
          floor = $("#floor0");
          floor.deadzone = viewport.height() - floor.height();
          floor.css("top", floor.deadzone);

          var floorNumber = viewport.width()/floor.width();
          for(var i = 0; i < floorNumber; i++)
          {
            //console.log("floor"+i+" created!");
            viewport.append("<div class='sprite floor'></div>");
          }

          floors = $(".floor");
          floors.each(function(i){
            $(this).css("left", floor.width() * i);
            $(this).css("top", floor.deadzone);
          });

          //cities
          city = $("#city0");
          city.yStart = floor.deadzone - city.height();
          city.css("top", city.yStart);

          var cityNumber = viewport.width()/city.width();
          for(var i = 0; i < cityNumber; i++)
          {
            //console.log("city"+i+" created!");
            viewport.append("<div class='sprite city'></div>");
          }

          cities = $(".city");
          cities.each(function(i){
            $(this).css("left", city.width() * i);
            $(this).css("top", city.yStart);
          });

          //inits
          bird.dom = $("#bird");
          startBtn = $("#start");
          numberProto = $("#numberProto");
          scorefield = $("#scorefield");
          Resize();

          pipes[0] = createPipe("pipe0", 1);
          pipes[1] = createPipe("pipe1", 2);
          pipes[2] = createPipe("pipe2", 3);

          scorefield.append("<div class='sprite numberB' id='score0'></div>");
          //$("score0").css("background-position", numberProto.css("background-position"));

          startBtn.on("click", startGame);

          $("body").keydown(function(event)
          {
            //console.log(event);
            switch(event.key)
            {
              case "Escape": togglePause();
              break;
              case "r": init();
              break;
            }
          });
        }

        //logic
        function resetGame()
        {
          bird.position.x = 0;
          bird.position.y = 0;
        }

        function startGame()
        {
          $("#viewport").on("click", click);

          bird.position.y = viewportSize.y * 0.5;

          togglePause();

          window.requestAnimationFrame(gameLoop);
          //gameLoop(0);
        }

        function click()
        {
          if(!gamePause)
            bird.velocity.y = -5;
        }

        function gameLoop(timeAlive)
        {
          if(gamePause)
            return;

          //console.log(deltaTime);

          if(startFrame == undefined)
          {
            startFrame = timeAlive;
          }

          // if(lastFrame == 0 || lastFrame == undefined)
          // {
          //   lastFrame = timeAlive;
          //   window.requestAnimationFrame(gameLoop);
          //   return;
          // }

          timeAlive -= startFrame;
          deltaTime = (timeAlive - lastFrame)*0.01;
          lastFrame = timeAlive;

          if(deltaTime > 0.1)
            deltaTime = 0.1;

          //move background
          var speedMultiplier = 1.0;
          var movePercentage = ((timeAlive*speedMultiplier)%1000)/1000;
          cities.each(function(i){
            //$(this).css("left", city.width() * i);
            $(this).css("left", city.width()*i - city.width()*movePercentage);
          });

          floors.each(function(i){
            //$(this).css("left", city.width() * i);
            $(this).css("left", floor.width()*i - floor.width()*movePercentage);
          });

          var pipeOffset = 0.3 * viewportSize.x;
          var floorMove = floor.width()*speedMultiplier*timeAlive/1000;
          pipes[0].css("left", viewportSize.x - (floorMove%viewport.width()));
          pipes[1].css("left", viewportSize.x + (pipeOffset) - floorMove);
          pipes[2].css("left", viewportSize.x + (pipeOffset * 2) - floorMove);

          if(viewportSize.x - floorMove+52 < 0)
          {
            console.log("boom!");
            pipes[0].remove();
            $("#pipe1").attr("id", "pipe0");
            $("#pipe2").attr("id", "pipe1");
            pipes[0] = $("#pipe0");
            pipes[1] = $("#pipe1");
            pipes[2] = createPipe("pipe2");
          }

          //physics
          if(bird.velocity.y <= 100)
            bird.velocity.y += 1*deltaTime;
          bird.position.y += bird.velocity.y;

          //logic
          if(bird.position.y + bird.dom.height() >= floor.deadzone)
            togglePause();

          bird.dom.css("top", bird.position.y);
          //bird.dom.animate({top: bird.position.x}, 32);

          window.requestAnimationFrame(gameLoop);
        }
      </script>
        <div id="viewport"></div>
    </body>
</html>
