<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">
        <script src="jquery-3.2.1.min.js"></script>
        <style type="text/css">
            body {
              margin:0; padding: 0; border:0; background: black;
                overflow: hidden;
            }

            div {
              position: absolute; margin: 0; padding: 0; border: 0;
                outline:0; color:white;
            }

            .sprite{
              background-image:url(sheet.png);
            }

            #viewport {
              width: 100%; height: 100%; overflow: hidden;
              top: 0px; left: 0px; margin: 0;
              background-color: #70C5CF;
              z-index: 0;
            }

            #bird {
              width: 34px;
              height: 24px;
              background-position: -312px -230px;
              z-index: 3;
              animation: cycle_sprites 300ms steps(1) infinite/*,
                          move_bird 5s linear infinite*/;
            }

            #start {
              background-position: -318px -382px;
              width: 80px;
              height: 28px;
              z-index: 3;
            }

            .city {
              background-position: -0px -410px;
              width: 276px;
              height: 200px;
            }

            #getready {
              background-position: -118px -310px;
              width: 288px;
              height: 38px;
            }

            .floor {
              background-position: -276px 0;
              width: 224px;
              height: 112px;
              z-index: 2;
            }

            .pipeN {
              /*251, 0, 26, 200*/
              background-position: -502px 0;
              width: 52px;
              height: 400px;
            }

            .pipeS {
              /*277, 0, 26, 200*/
              background-position: -554px 0;
              width: 52px;
              height: 400px;
            }

            .numberS {
              /* 0, 177, 6,  7 */
              background-position: 0 -354px;
              width: 12px;
              height: 14px;
            }

            .numberB {
              /* 0, 177, 6,  7 */
              background-position: 0 -376px;
              width: 14px;
              height: 20px;
              display: inline-block;
              position: relative;
              margin-left: 3px;
            }

            .hidden {
              display: none;
            }

            #scorefield {
              margin-top: 10%;
              margin-left: 50%;
              transform: scale(2);
              z-index: 2;
              /*text-align: center;*/
            }

            #debug {
              z-index: 100;
            }

            @keyframes cycle_sprites {
                0% { background-position: -312px -230px; }
                33.33% { background-position: -312px -256px;}
                66.66% { background-position: -312px -282px;}
            }

            @keyframes move_bird {
                from { left: 0px}
                to { left: 500px}
            }
        </style>
    </head>
    <body>
      <script type="text/javascript">
        //classes
        function Vec2()
        {
          this.x = 0;
          this.y = 0;
        }

        function Bird()
        {
          this.velocity = new Vec2();
          this.position = new Vec2();
          this.dom = undefined;
        }

        function Resize()
        {
          viewportSize.x = $("#viewport").width();
          viewportSize.y = $("#viewport").height();
          startBtn.css({"top": viewportSize.y * 0.5 - 40, "left": viewportSize.x * 0.5 - 28});

          bird.position.x = viewportSize.x * 0.3;
          bird.dom.css("left", bird.position.x);
          bird.position.y = viewportSize.y * 0.5;
          bird.dom.css("top", bird.position.y);

          console.log("resize!");
        }

        function setPipeSlot(id, slot)
        {
          if(slot == undefined)
            slot = Math.floor(Math.random()*5);
          slot++;
          if(slot < 1)
            slot = 1;
          else if(slot > 3)
            slot = 3;
          if(randomNr[slot] == undefined)
            randomNr[slot] = 0;
          randomNr[slot]++;
          var pipe = $("#"+id);
          var pipeN = $("#"+id+"N");
          var pipeS = $("#"+id+"S");
          var gap = 0.2;
          var usable = floor.deadzone - viewport.height()*0.1;
          var positionY = (usable/4)*slot;
          pipeN.css("top", positionY+(usable*gap));
          pipeS.css("top", -pipeS.height()+positionY-(usable*gap));
          pipe.css("left", viewport.width());
          return pipe;
        }

        function createPipe(id, slot)
        {
          console.log("pipe '" + id + "' created");
          viewport.append("<div class='hidden pipe' id='"+id+"'><div class='sprite pipeN' id='"+id+"N'></div><div class='sprite pipeS' id='"+id+"S'></div></div>");
          setPipeSlot(id);
          $("#"+id).removeClass("hidden");
          return $("#"+id);
        }

        function togglePause()
        {
          console.log("PAUSE!");
          gamePause = !gamePause;

          if(gamePause){
            startBtn.show();
          } else {
              startBtn.hide();
          }
        }

        //some init stuff
        var bird = new Bird(),
            gamePause = true,
            viewportSize = new Vec2(),
            viewport,
            floor,
            floors,
            city,
            cities,
            startBtn,
            gameLoopInterval = undefined,
            startFrame = undefined,
            lastFrame = 0,
            deltaTime,
            distance = 0,
            numberProto,
            scorefield,
            pipes = [],
            randomNr = [],
            pipeDistance = 52 * 5;

        //handler
        $(document).ready(function() {
          init();
        });

        $(window).resize(Resize);

        function init(){
          viewport = $("#viewport");
          viewport.html(
          "<div class='sprite' id='start'></div>"
          +"<div class='' id='scorefield'></div>"
          +"<div class='sprite' id='bird'></div>"
          +"<div id='city0' class='sprite city'></div>"
          +"<div id='floor0' class='sprite floor'></div>"
          +"<div id='numberProto' class='sprite numberS hidden'></div>"
          );

          //floors
          //viewport.append("<div id='floor0' class='sprite floor'></div>");
          floor = $("#floor0");
          floor.deadzone = viewport.height() - floor.height();
          floor.css("top", floor.deadzone);

          var floorNumber = viewport.width()/floor.width();
          for(var i = 0; i < floorNumber; i++)
          {
            //console.log("floor"+i+" created!");
            viewport.append("<div id='floor"+(i+1)+"' class='sprite floor'></div>");
          }

          floors = $(".floor");
          floors.each(function(i){
            floors[i].position = floor.width() * i;
            $(this).css("left", floors[i].position);
            $(this).css("top", floor.deadzone);
          });

          //cities
          city = $("#city0");
          city.yStart = floor.deadzone - city.height();
          city.position = 0;
          city.css("top", city.yStart);

          var cityNumber = viewport.width()/city.width();
          for(var i = 0; i < cityNumber; i++)
          {
            //console.log("city"+i+" created!");
            viewport.append("<div id='city"+(i+1)+"' class='sprite city'></div>");
          }

          cities = $(".city");
          cities.each(function(i){
            cities[i].position = city.width() * i;
            $(this).css("left", cities[i].position);
            $(this).css("top", city.yStart);
          });

          //inits
          bird.dom = $("#bird");
          startBtn = $("#start");
          numberProto = $("#numberProto");
          scorefield = $("#scorefield");
          Resize();

          scorefield.append("<div class='sprite numberB' id='score2'></div>");
          scorefield.append("<div class='sprite numberB' id='score1'></div>");
          scorefield.append("<div class='sprite numberB' id='score0'></div>");
          scorefield.css("left", -scorefield.width()/2);

          startBtn.on("click", startGame);

          $(document).keydown(function(event)
          {
            console.log(event);
            switch(event.key)
            {
              case "Escape": togglePause();
              break;
              case "r": init();
              break;
            }
          });
        }

        //logic
        function resetGame()
        {
          bird.position.x = 0;
          bird.position.y = 0;
        }

        function startGame()
        {
          //init();

          $("#viewport").on("click", click);

          bird.position.y = viewportSize.y * 0.5;

          distance = 0;
          for(var i = 0; i < 3; i++)
          {
            if(pipes.length < 3)
            {
              pipes[i] = {};
              pipes[i].dom = createPipe("pipe"+i);
            }
            pipes[i].position = viewport.width() + (pipeDistance*i);
          }

          scorefield.children("#score0").css("background-position-x", "");
          scorefield.children("#score1").css("background-position-x", "");
          scorefield.children("#score2").css("background-position-x", "");

          togglePause();

          //startFrame = undefined;

          window.requestAnimationFrame(gameLoop);
        }

        function click()
        {
          if(!gamePause)
          {
            bird.velocity.y = -5;
            console.log("Jump!");
          }
          else {
            console.log("Put Your Hands Up In The Air!");
          }
        }

        function gameLoop(timeAlive)
        {
          if(gamePause)
            return;

          if(startFrame == undefined)
          {
            startFrame = timeAlive;
          }

          // if(lastFrame == 0 || lastFrame == undefined)
          // {
          //   lastFrame = timeAlive;
          //   window.requestAnimationFrame(gameLoop);
          //   return;
          // }

          timeAlive -= startFrame;
          deltaTime = (timeAlive - lastFrame)*0.01;//ms to s conversion
          lastFrame = timeAlive;

          if(deltaTime > 0.1)
            deltaTime = 0.1;

          //move background
          var citySpeedMultiplier = 5;
          cities.each(function(i){
            cities[i].position -= deltaTime*citySpeedMultiplier;
            $(this).css("left", cities[i].position);
          });

          if(cities[0].position + city.width() < 0)
          {
            cities.each(function(i){
              cities[i].position = city.width() * i;
            });
          }

          //move active elements
          var activeSpeedMultiplier = 30;
          floors.each(function(i){
            floors[i].position -= deltaTime*activeSpeedMultiplier;
            $(this).css("left", floors[i].position);
          });

          if(floors[0].position + floor.width() < 0)
          {
            floors.each(function(i){
              floors[i].position = floor.width() * i;
            });
          }

          var pipeOffset = 0.3 * viewportSize.x;
          var floorMove = activeSpeedMultiplier*deltaTime;
          for(var i = 0; i < pipes.length; i++)
          {
            pipes[i].position -= floorMove;
            pipes[i].dom.css("left", pipes[i].position);

            if(pipes[i].position+52 < 0)
            {
              pipes[i].position = pipeDistance * pipes.length - 52;
              setPipeSlot("pipe"+i);
            }
          }

          //physics
          if(bird.velocity.y <= 100)
            bird.velocity.y += 2*deltaTime;

          //logic
          distance += floorMove;

          if(bird.position.y + bird.dom.height() >= floor.deadzone)
          {
            //bird.velocity.y = 0;
            togglePause();
          }

          for(var i = 0; i < pipes.length; i++)
          {
            if(bird.position.x > pipes[i].position
              && bird.position.x + bird.dom.width() < pipes[i].position + pipes[i].dom.children(0).width()
              && (bird.position.y > pipes[i].dom.children(".pipeN").position().top
              || bird.position.y < pipes[i].dom.children(".pipeS").position().top + pipes[i].dom.children(".pipeS").height()))
            {
              togglePause();
              console.log("bomp");
              //(pipes[i].dom.children(0).position.top
            }
          }

          bird.position.y += bird.velocity.y;
          bird.dom.css("top", bird.position.y);
          //bird.dom.animate({top: bird.position.x}, 32);

          //Score
          var score = Math.max(0, Math.floor((distance)/pipeDistance));
          var score0 = score.toString()[score.toString().length-1];
          var score1 = score.toString()[score.toString().length-2];
          var score2 = score.toString()[score.toString().length-3];
          scorefield.children("#score0").css("background-position-x", (score0)*-16);
          scorefield.children("#score1").css("background-position-x", (score1)*-16);
          scorefield.children("#score2").css("background-position-x", (score2)*-16);

          window.requestAnimationFrame(gameLoop);
        }
      </script>
        <div id="debug"></div>
        <div id="viewport"></div>
    </body>
</html>
